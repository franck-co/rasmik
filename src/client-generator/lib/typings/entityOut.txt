import { ExpandProperty, HasCompositePk, PkKeys, Primary, RootEntity, ScalarKey, RelationKey } from './utility'
import { AllowProperty, PushDefNodeObject, PushDefNodeObjects, PushDefNodePk, PushDefNodePks, PushDef } from './pushDef'

export type EntityOUT<E extends RootEntity, Def extends PushDef<E>> 
= Def['nodeType'] extends 'collection' | 'pks' | 'objects' ? Array<EntityOUTItem<E,Def>> : EntityOUTItem<E,Def>




type EntityOUTItem<E extends RootEntity, Def extends PushDef<E>> 
= Def extends  PushDefNodePk<E> |PushDefNodePks<E> ? EntityOUTPK<E,Def>
: Def extends  PushDefNodeObject<E> |  PushDefNodeObjects<E> ? EntityOutObject<E,Def>
: never


type EntityOUTPK<E extends RootEntity, Def extends PushDefNodePk<E> |PushDefNodePks<E>> = Primary<E>


type EntityOutObject<E extends RootEntity, Def extends PushDefNodeObject<E> |  PushDefNodeObjects<E> > = 
{
    [K in Extract<keyof Def['children'],keyof E>]: EntityOUT<ExpandProperty<E[K]>, Def['children'][K]>
}
&
//own props (apart from pks)
{
    [K in Exclude<ScalarKey<E>,PkKeys<E>>]?: E[K]
}

& //required pks (apart from Relation-pk that should be in the def)
{
    [K in   Extract<Exclude<RequiredPkKeys<E, Def['allow']>,RelationKey<E>>,keyof E> ] : E[K]
}
& //optional pks
{
    [K in   Extract<OptionalPkKeys<E, Def['allow']>,keyof E> ]? : E[K]
}



type RequiredPkKeys<E extends RootEntity, AL extends AllowProperty >  
= AL extends 'create' ? 
    HasCompositePk<E> extends true ?  PkKeys<E> :  never //Pas de pk si pk unique et creation (et autoincrement (pk unique numérique))
: AL extends 'update' | 'ref' | undefined ? PkKeys<E> //nécessaire pour l'update (undefined -> default value is ref)
: AL extends 'upsert' ? 
    HasCompositePk<E> extends true ?  PkKeys<E> :  never
: never

type OptionalPkKeys<E extends RootEntity, AL extends AllowProperty > 
= AL extends 'upsert' ?
HasCompositePk<E> extends true ?  never :  PkKeys<E> 
: never




// /** Exemple */
// import {Teacher} from '../../entities'
// const [teacherOUT, def] = getTypedEntityOUT(Teacher, {
//     nodeType:'objects',
//     allow:'create',
//     //exclude:['iban'],
//     collectionMode:'add',
//     deleteOrphans:false,
//     children:{
//        Candidature:{
//            nodeType:'object',
//            allow:'update',
//        },
//        Addresses:{
//            allow:'upsert',
//            nodeType:'objects',
//            collectionMode:'set',
//            deleteOrphans:false,
//            exclude:['coordinates'],
//            children:{
//                Family:{

//                    nodeType:'pk',

//                }
//            }
//        },
//        TeachingLevels:{
//            nodeType:'objects',
//            collectionMode:'set',
//            deleteOrphans:false,
//            allow:'upsert'
//        }
//     }   
// } as const)

// teacherOUT[0].TeachingLevels[0]
